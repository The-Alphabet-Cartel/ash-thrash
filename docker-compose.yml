# =============================================================================
# ASH-THRASH DOCKER COMPOSE CONFIGURATION
# Repository: https://github.com/the-alphabet-cartel/ash-thrash
# Discord: https://discord.gg/alphabetcartel
# Website: http://alphabetcartel.org
# =============================================================================

services:
  # =========================================================================
  # Ash-Thrash Service
  # =========================================================================
  ash-thrash:
    build:
      context: .
    image: ghcr.io/the-alphabet-cartel/ash-thrash:latest
    container_name: ash-thrash
    restart: unless-stopped
    networks:
      ash-network:
        ipv4_address: 172.20.0.14
    
    # Keep the container running with a long-lived command
    # This allows you to exec into it for CLI operations
    command: ["tail", "-f", "/dev/null"]
    
    environment:
      - TZ=America/Los_Angeles
    volumes:
      - ./results:/app/results
      - ./logs:/app/logs
      - ./reports:/app/reports
#      - ./secrets:/run/secrets:ro
    depends_on:
      - ash-nlp-check
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2'
        reservations:
          memory: 256M
          cpus: '1'

  # =========================================================================
  # NLP Server Health Check (dependency)
  # =========================================================================
  ash-nlp-check:
    image: curlimages/curl:latest
    container_name: ash-nlp-health-check
    restart: "no"
    networks:
      ash-network:
        ipv4_address: 172.20.0.15
    command: >
      sh -c "
        echo 'Checking NLP server health...';
        until curl -f ${GLOBAL_NLP_API_URL:-http://172.20.0.11:8881}/health; do
          echo 'NLP server not ready, waiting...';
          sleep 5;
        done;
        echo 'NLP server is healthy!';
        exit 0;
      "

networks:
  ash-network:
    name: ash-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1

volumes:
  ash-thrash-reports:
    name: ash-thrash-reports
    driver: local
  ash-thrash-results:
    name: ash-thrash-results
    driver: local
  ash-thrash-logs:
    name: ash-thrash-logs
    driver: local